name: Cleanup Preview Environment

on:
    pull_request:
        types: [closed] # Triggers when PR is closed (merged or just closed)
    delete:
        branches:
            - "**" # Triggers when any branch is deleted
            - "!dependabot/**"

jobs:
    cleanup-preview:
        runs-on: ubuntu-latest
        # Only run if it's a feature branch (not main)
        if: github.event.ref != 'refs/heads/main'

        steps:
            - name: Check if droplet exists
              id: droplet-check
              run: |
                  if [ -n "${{ secrets.DROPLET_ID }}" ]; then
                    echo "HAS_DROPLET=true" >> "$GITHUB_OUTPUT"
                    echo "Droplet ID exists, will cleanup"
                  else
                    echo "HAS_DROPLET=false" >> "$GITHUB_OUTPUT"
                    echo "No droplet configured, skipping cleanup"
                  fi

            - name: Extract branch name
              if: steps.droplet-check.outputs.HAS_DROPLET == 'true'
              id: branch
              run: |
                  if [ "${{ github.event_name }}" == "delete" ]; then
                    # For delete events
                    BRANCH="${{ github.event.ref }}"
                  else
                    # For PR closed events
                    BRANCH="${{ github.event.pull_request.head.ref }}"
                  fi
                  echo "BRANCH_NAME=${BRANCH}" >> $GITHUB_OUTPUT
                  echo "Cleaning up branch: ${BRANCH}"

            - name: Teardown preview environment
              if: steps.droplet-check.outputs.HAS_DROPLET == 'true'
              continue-on-error: true # Don't fail workflow if cleanup fails
              uses: appleboy/ssh-action@v1.2.3
              with:
                  host: ${{ secrets.DROPLET_IP }}
                  username: root
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      # Check if preview exists before cleanup
                      if [ -d "/var/www/${{ steps.branch.outputs.BRANCH_NAME }}" ]; then
                          /root/scripts/cleanup-preview.sh "${{ steps.branch.outputs.BRANCH_NAME }}"
                          echo "✅ Cleaned up preview for ${{ steps.branch.outputs.BRANCH_NAME }}"
                      else
                          echo "⏭️  No preview environment found for ${{ steps.branch.outputs.BRANCH_NAME }}"
                      fi
